#!/bin/bash

# Step 1: Apply updated deployment (trigger rolling update)
echo "🚀 Applying rolling update for django-blue..."
kubectl apply -f messaging_app/blue_deployment.yaml

# Step 2: Monitor rollout progress
echo "🔍 Monitoring rollout status..."
kubectl rollout status deployment/django-blue

# Step 3: Continuous health check (simulate user requests)
SERVICE_URL="http://localhost:8000"  # Change if Ingress or NodePort differs
echo "🩺 Checking for downtime during rollout..."

for i in {1..20}; do
  if curl -s --head --request GET "$SERVICE_URL" | grep "200 OK" > /dev/null; then
    echo "✅ App responding normally (request $i)"
  else
    echo "❌ Possible downtime detected (request $i)"
  fi
  sleep 3
done

# Step 4: Verify pods after rollout
echo "📦 Verifying running pods after rollout..."
kubectl get pods -l app=django-blue
        